name: Build RC Generator for Windows and macOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "RC_Generator" --add-data "Planificare Elmet.xlsx;." --add-data "Tehnologii.xlsx;." --version-file "version_info.txt" --manifest "manifest.xml" route_card_coc_app.py
    
    - name: Create Windows installer folder
      run: |
        mkdir RC_Generator_Windows_Installer
        copy "dist\RC_Generator.exe" "RC_Generator_Windows_Installer\"
        copy "README_Installation.md" "RC_Generator_Windows_Installer\README.txt"
        copy "Planificare Elmet.xlsx" "RC_Generator_Windows_Installer\"
        copy "Tehnologii.xlsx" "RC_Generator_Windows_Installer\"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: RC_Generator_Windows
        path: RC_Generator_Windows_Installer/
        retention-days: 90

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        # Install macOS specific dependencies
        pip install dmgbuild || echo "dmgbuild not available, using hdiutil"
        
    - name: Debug Python and PyQt6 installation
      run: |
        python --version
        python -c "from PyQt6.QtCore import QT_VERSION_STR; print('PyQt6 version:', QT_VERSION_STR)"
        python -c "import sys; print('Python executable:', sys.executable)"
        python -c "import PyQt6; print('PyQt6 installed successfully')"
        python -c "import PyQt6.QtWidgets; print('PyQt6.QtWidgets imported successfully')"
        python -c "import pandas; print('pandas imported successfully')"
        python -c "import numpy; print('numpy imported successfully')"
        python -c "import xlsxwriter; print('xlsxwriter imported successfully')"
        python -c "import openpyxl; print('openpyxl imported successfully')"
        
    - name: Test script imports
      run: |
        python -c "
        try:
            import sys
            import os
            sys.path.insert(0, '.')
            # Test imports without GUI initialization
            print('Testing script imports...')
            import pandas as pd
            import numpy as np
            from PyQt6.QtWidgets import QApplication
            from PyQt6.QtCore import Qt
            import xlsxwriter
            import openpyxl
            print('All imports successful!')
        except Exception as e:
            print(f'Import error: {e}')
            sys.exit(1)
        "
    
    - name: Build macOS application
      run: |
        set -e  # Exit on any error
        echo "Starting PyInstaller build..."
        pyinstaller --noconfirm --log-level=INFO RC_Generator.spec
        echo "PyInstaller build completed"
        
    - name: Check build output
      run: |
        echo "Checking dist directory:"
        ls -la dist/
        echo "Checking if app exists:"
        if [ -d "dist/RC Generator.app" ]; then
          echo "✅ RC Generator.app created successfully"
          ls -la "dist/RC Generator.app/"
        else
          echo "❌ RC Generator.app not found"
          exit 1
        fi
        
    - name: Create DMG
      run: |
        mkdir dmg_temp
        cp -R "dist/RC Generator.app" dmg_temp/
        ln -s /Applications dmg_temp/Applications
        hdiutil create -volname "RC Generator" -srcfolder dmg_temp -ov -format UDZO "RC_Generator.dmg"
        rm -rf dmg_temp
    
    - name: Create macOS installer folder
      run: |
        mkdir RC_Generator_macOS_Installer
        cp "RC_Generator.dmg" "RC_Generator_macOS_Installer/"
        cp "README_Installation.md" "RC_Generator_macOS_Installer/"
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RC_Generator_macOS
        path: RC_Generator_macOS_Installer/
        retention-days: 90

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: RC_Generator_Windows
        path: windows/
        
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: RC_Generator_macOS
        path: macos/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          windows/*
          macos/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
